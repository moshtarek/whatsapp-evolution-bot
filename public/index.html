<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙˆØª</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea { height: 80px; resize: vertical; }
        button { background: #007cba; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #005a87; }
        button.delete { background: #dc3545; }
        button.delete:hover { background: #c82333; }
        button.edit { background: #28a745; margin-left: 5px; }
        button.edit:hover { background: #218838; }
        .rules-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .rules-table th, .rules-table td { padding: 12px; text-align: right; border-bottom: 1px solid #ddd; }
        .rules-table th { background: #f8f9fa; font-weight: bold; }
        .rules-table tr:hover { background: #f5f5f5; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .status.active { background: #d4edda; color: #155724; }
        .status.inactive { background: #f8d7da; color: #721c24; }
        .match-type { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #e9ecef; color: #495057; }
        .loading { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨</h1>
        
        <div class="form-section">
            <h2>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="ruleForm">
                <input type="hidden" id="ruleId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="pattern">Ø§Ù„Ù†Ù…Ø·/Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©:</label>
                        <input type="text" id="pattern" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø­Ø¨Ø§">
                    </div>
                    <div class="form-group">
                        <label for="matchType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</label>
                        <select id="matchType" required>
                            <option value="EXACT">ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„</option>
                            <option value="STARTS_WITH">ÙŠØ¨Ø¯Ø£ Ø¨Ù€</option>
                            <option value="CONTAINS">ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰</option>
                            <option value="REGEX">ØªØ¹Ø¨ÙŠØ± Ù†Ù…Ø·ÙŠ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reply">Ø§Ù„Ø±Ø¯:</label>
                        <textarea id="reply" required placeholder="Ù…Ø«Ø§Ù„: Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="lang">Ø§Ù„Ù„ØºØ©:</label>
                        <select id="lang">
                            <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="en">English</option>
                            <option value="any">Ø£ÙŠ Ù„ØºØ©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="priority">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</label>
                        <input type="number" id="priority" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="active">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                        <select id="active">
                            <option value="1">Ù†Ø´Ø·</option>
                            <option value="0">ØºÙŠØ± Ù†Ø´Ø·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="businessHours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ÙÙ‚Ø·:</label>
                        <select id="businessHours">
                            <option value="0">Ù„Ø§</option>
                            <option value="1">Ù†Ø¹Ù…</option>
                        </select>
                    </div>
                </div>
                <button type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø©</button>
                <button type="button" id="cancelBtn" onclick="cancelEdit()" style="display:none; background:#6c757d;">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>

        <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        
        <div>
            <h2>Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
            <table class="rules-table" id="rulesTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        <th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
                        <th>Ø§Ù„Ù„ØºØ©</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</th>
                        <th>Ø§Ù„Ø±Ø¯</th>
                        <th>Ø§Ù„Ù†Ù…Ø·</th>
                        <th>Ø§Ù„Ø±Ù‚Ù…</th>
                    </tr>
                </thead>
                <tbody id="rulesBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = '';
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', loadRules);
        
        // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('ruleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveRule();
        });

        async function loadRules() {
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await fetch('/rules');
                const rules = await response.json();
                displayRules(rules);
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayRules(rules) {
            const tbody = document.getElementById('rulesBody');
            tbody.innerHTML = '';
            
            rules.forEach(rule => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <button class="edit" onclick="editRule(${rule.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="delete" onclick="deleteRule(${rule.id})">Ø­Ø°Ù</button>
                    </td>
                    <td>${rule.only_in_business_hours ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
                    <td><span class="status ${rule.active ? 'active' : 'inactive'}">${rule.active ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
                    <td>${rule.priority}</td>
                    <td>${rule.lang}</td>
                    <td><span class="match-type">${getMatchTypeText(rule.match_type)}</span></td>
                    <td style="max-width: 200px; word-wrap: break-word;">${rule.reply}</td>
                    <td>${rule.pattern}</td>
                    <td>${rule.id}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getMatchTypeText(type) {
            const types = {
                'EXACT': 'ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„',
                'STARTS_WITH': 'ÙŠØ¨Ø¯Ø£ Ø¨Ù€',
                'CONTAINS': 'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰',
                'REGEX': 'ØªØ¹Ø¨ÙŠØ± Ù†Ù…Ø·ÙŠ'
            };
            return types[type] || type;
        }

        async function saveRule() {
            const ruleId = document.getElementById('ruleId').value;
            const ruleData = {
                pattern: document.getElementById('pattern').value,
                match_type: document.getElementById('matchType').value,
                reply: document.getElementById('reply').value,
                lang: document.getElementById('lang').value,
                priority: parseInt(document.getElementById('priority').value),
                active: parseInt(document.getElementById('active').value),
                only_in_business_hours: parseInt(document.getElementById('businessHours').value)
            };

            try {
                let response;
                if (ruleId) {
                    // ØªØ¹Ø¯ÙŠÙ„
                    response = await fetch(`/rules/${ruleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ruleData)
                    });
                } else {
                    // Ø¥Ø¶Ø§ÙØ©
                    response = await fetch('/rules', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ruleData)
                    });
                }

                if (response.ok) {
                    alert(ruleId ? 'ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                    document.getElementById('ruleForm').reset();
                    cancelEdit();
                    loadRules();
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£: ' + error.message);
            }
        }

        async function editRule(id) {
            try {
                const response = await fetch(`/rules/${id}`);
                const rule = await response.json();
                
                document.getElementById('ruleId').value = rule.id;
                document.getElementById('pattern').value = rule.pattern;
                document.getElementById('matchType').value = rule.match_type;
                document.getElementById('reply').value = rule.reply;
                document.getElementById('lang').value = rule.lang;
                document.getElementById('priority').value = rule.priority;
                document.getElementById('active').value = rule.active;
                document.getElementById('businessHours').value = rule.only_in_business_hours;
                
                document.getElementById('submitBtn').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©';
                document.getElementById('cancelBtn').style.display = 'inline-block';
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: ' + error.message);
            }
        }

        function cancelEdit() {
            document.getElementById('ruleId').value = '';
            document.getElementById('submitBtn').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø©';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('ruleForm').reset();
        }

        async function deleteRule(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©ØŸ')) return;
            
            try {
                const response = await fetch(`/rules/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                    loadRules();
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£: ' + error.message);
            }
        }
    </script>
</body>
</html>
